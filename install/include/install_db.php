<?php
if (INDEXPHP != 1) die('You can\'t access this file directly...');

$action = isset($_REQUEST['action']) ? $_REQUEST['action'] : '';
$database_host = isset($_POST['database_host']) ? $_POST['database_host'] : '';
$database_username = isset($_POST['database_username']) ? $_POST['database_username'] : '';
$database_password = isset($_POST['database_password']) ? $_POST['database_password'] : '';
$database_name = isset($_POST['database_name']) ? $_POST['database_name'] : '';
$database_created = isset($_POST['database_created']) ? $_POST['database_created'] : '';

themeleftbox('Создание базы данных ', '', '', true);
echo '<tr><td>';

switch ($action) {
    case "process_sql":
        echo "<p>Connecting to MySQL...</p>";

        // Створюємо з'єднання з базою даних
        $mysqli = new mysqli($database_host, $database_username, $database_password);

        // Перевіряємо з'єднання
        if ($mysqli->connect_error) {
            die("<p style='color:red;'>Ошибка. Невозможно соединиться с MySQL: " . $mysqli->connect_error . "</p>");
        }

        echo "Connected";

        if (!$database_created) {
            echo "<br>Creating database '$database_name' ";
            $mysqli->query("CREATE DATABASE `$database_name`") or die("<p style='color:red;'>Ошибка создания базы данных: " . $mysqli->error . "</p>");
        }

        if ($mysqli->select_db($database_name)) {
            $mysqli->query("ALTER DATABASE `$database_name` DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci") or die("<p style='color:red;'>Ошибка при изменении базы данных: " . $mysqli->error . "</p>");
            echo "<br>Processing SQL dump...";

            $file_path = dirname(__FILE__) . "/opentest2.sql";
            $sql_file = file_get_contents($file_path);
            $additional_path = dirname($_SERVER['REQUEST_URI']);
            $sql_file = str_replace("add_path/media", "$additional_path/media", $sql_file);
            $queries = explode(";\n", $sql_file);

            foreach ($queries as $query) {
                if (trim($query)) {
                    $mysqli->query($query) or die("<p style='color:red;'>Ошибка выполнения SQL-запроса: " . $mysqli->error . "</p>");
                }
            }

            echo "<p style='color:green'>База данных успешно создана!</p>
            <form action='index.php?page=configure_opentest' method='post'>
                <input type='hidden' name='database_host' value='$database_host'>
                <input type='hidden' name='database_username' value='$database_username'>
                <input type='hidden' name='database_password' value='$database_password'>
                <input type='hidden' name='database_name' value='$database_name'>
                <input type='submit' value='Continue'>
            </form>";
        } else {
            echo "<p style='color:red;'>Ошибка. База данных '$database_name' не создана!</p>";
        }

        $mysqli->close();
        break;

    default:
        draw_mysql_form();
}

function draw_mysql_form() {
    echo "<p>
    Заполните поля в соответствии с настройками вашей БД и нажмите 'Install Database' для продолжения.
    </p>
    <form method='post'>
        <input type='hidden' name='action' value='process_sql'>
        <table>
            <tr>
                <td>Database Host</td>
                <td><input type='text' name='database_host' value='localhost'></td>
            </tr>
            <tr>
                <td>Database Username</td>
                <td><input type='text' name='database_username' value='root'></td>
            </tr>
            <tr>
                <td>Database Password</td>
                <td><input type='text' name='database_password' value=''></td>
            </tr>
            <tr>
                <td>Database Name</td>
                <td><input type='text' name='database_name' value=''></td>
            </tr>
            <tr>
                <td>Эта база данных уже создана?</td>
                <td>
                    <input type='radio' name='database_created' value='1' id='created_radio1'>
                    <label for='created_radio1'>Да</label><br>
                    <input type='radio' name='database_created' value='0' id='created_radio2'>
                    <label for='created_radio2'>Нет (будет попытка создать базу сейчас)</label>
                </td>
            </tr>
        </table>
        <input type='submit' value='Install Database'>
    </form>";
}
?>
    <h3>Платная поддержка частных и корпоративных пользователей</h3>
    Создатель программы тестирования OpenTEST2 предоставляет на коммерческой основе поддержку пользователей OpenTEST2.<br>
    <ul>
        <li>Установка и настройка</li>
        <li>Брендирование</li>
        <li>Изменение программы</li>
        <li>Администрирование и поддержка</li>
        <li>Обучение персонала</li>
        <li>Консультации</li>
    </ul>

    Говорить о какой-либо платности самого дистрибутива конечно же не надо. <br>OpenTEST2 — открытая и бесплатная программа, такой она пока и останется, несмотря на появившуюся платную поддержку.
    <br><br>
    <b>Заказать платную поддержку:</b> premium@opentest.com.ua
<?php
